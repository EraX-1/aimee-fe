# AIMEE システム使い方ガイド

## 🎯 できること

### 1. リアルタイムアラート確認
**画面**: サイドバー「🚨 アラート」セクション

**表示されるアラート**:
- 🔴 SS案件大量受領アラート (1,269件受領)
- 🟡 長時間配置の検出 (90分配置)

**操作**:
- 「🔄 データ更新」ボタンでアラート再取得
- アラートをクリックして詳細確認 (今後実装)

**質問例**:
```
✅ できる質問:
- "現在のアラートを教えて"
- "SS案件大量受領アラートに対応してください"
- "長時間配置の検出に対応してください"
```

---

### 2. AI配置調整チャット
**画面**: メイン画面「💬 配置調整アシスタント」

**できること**:
- 拠点・工程の人員不足を相談
- AI が実データから配置転換案を提案
- 配置変更を承認してDB保存

**質問例**:
```
✅ できる質問:
1. 具体的な拠点・工程を指定
   - "札幌のエントリ1が不足しています"
   - "品川の補正工程が遅延しています"
   - "東京のSV補正に2名必要です"

2. アラート対応
   - "SS案件大量受領アラートに対応してください"
   - "長時間配置の検出に対応してください"

3. 状況確認
   - "現在の配置状況を教えて"
   - "各拠点の人員状況は?"

❌ できない質問 (情報不足):
- "よろしく"
- "なんとかして"
- "テスト"

→ AIが追加情報を要求します:
  「以下を入力してください:
   - 拠点名 (例: 札幌、東京、大阪)
   - 工程名 (例: エントリ1、補正、SV補正)
   - 問題内容 (例: 遅延、人員不足)」
```

---

### 3. 配置転換提案の確認と承認

**AIが配置提案を生成する条件**:
1. ✅ 余剰人員がある拠点がある (3名以上配置)
2. ✅ 不足している拠点がある (1名以下)
3. ✅ 同じ工程で余剰と不足がマッチング

**配置提案カードの表示**:
```
┌────────────────────────────────────┐
│ 📋 配置調整提案の詳細              │
├────────────────────────────────────┤
│ 🔄 配置変更内容                    │
│                                    │
│  佐世保  →  札幌  (エントリ1: 1名) │
│  東京    →  札幌  (エントリ2: 1名) │
│  東京    →  札幌  (補正: 1名)      │
│                                    │
│ 📈 予測される効果                  │
│  生産性: +30%                      │
│  遅延: -45分                       │
│  品質: 維持                        │
│                                    │
│ 💡 実データに基づく3名の配置調整   │
│                                    │
│  [✅ 承認] [❌ 却下] [💬 詳細相談] │
└────────────────────────────────────┘
```

**承認ボタン**:
- ✅ **承認**: `approval_history` テーブルにINSERT (別アプリが読み取り可能)
- ❌ **却下**: 却下理由を記録
- 💬 **詳細相談**: 追加質問モード (今後実装)

**配置提案がない場合**:
- AIテキストのみ表示: 「現在のリソースで対応可能です」
- 提案カードは非表示

---

### 4. システム状態確認

**サイドバー「ℹ️ システム情報」**:
- 現在はコメントアウト (今後実装)
- 稼働率、処理済み案件などを表示予定

---

## 💬 チャット利用シナリオ

### シナリオ1: 拠点の人員不足対応

**ユーザー**:
```
札幌のエントリ1が不足しています
```

**AIの処理**:
1. 意図解析: delay_resolution (遅延解消)
2. DB照会: login_records_by_location から配置状況取得
3. 余剰人員発見: 東京のエントリ1に1名余剰
4. 配置提案生成: 東京 → 札幌 (エントリ1: 1名)
5. 応答生成: Ollamaで自然言語化

**AI応答** (処理時間: 5〜10秒):
```
札幌のエントリ1不足を解消するため、以下の配置転換を行います。

* 佐世保のエントリ1から札幌へ1名を配置します。
* 東京のエントリ2から札幌へ1名を配置します。

[配置調整提案カードが表示される]
```

---

### シナリオ2: アラート対応

**ユーザー**:
```
SS案件大量受領アラートに対応してください
```

**AIの処理**:
1. 意図解析: resource_allocation (人員配置)
2. 全拠点のデータ取得
3. 配置提案生成

**AI応答**:
```
SS案件1,269件の受領に対応するため、以下の配置を提案します。

* 東京の補正から札幌へ1名を配置します。

[配置調整提案カードが表示される]
```

---

### シナリオ3: 情報不足の場合

**ユーザー**:
```
よろしく
```

**AI応答** (即時):
```
入力「よろしく」では情報不足です。以下を入力してください:
- 拠点名 (例: 札幌、東京、大阪)
- 工程名 (例: エントリ1、補正、SV補正)
- 問題内容 (例: 遅延、人員不足)
```

[提案カードは表示されない]

---

### シナリオ4: 対応不要の場合

**ユーザー**:
```
沖縄の補正工程の状況は?
```

**AI応答**:
```
現在のリソースで対応可能です。
```

[提案カードは表示されない]

---

## 🔍 データの見方

### login_records_by_location テーブル
```
業務名: 新SS(片道)
工程名: エントリ1
札幌: 1名  ← 不足 (2名必要)
東京: 3名  ← 余剰 (2名で十分、1名余剰)
大阪: 0名  ← 不足 (2名必要)
沖縄: 0名  ← 不足 (2名必要)
佐世保: 0名 ← 不足 (2名必要)
```

**AI判定**:
- 3名以上 = 余剰 (2名を残して余剰人数を計算)
- 1名 = 不足 (1名追加で2名に)
- 0名 = データなし (除外)

---

## ⏱️ 処理時間の目安

### アラート表示
- **初回**: 1〜2秒 (DB接続含む)
- **2回目以降**: 即時 (キャッシュ)

### チャット応答
- **情報不足判定**: 2秒 (意図解析のみ)
- **配置提案あり**: 5〜10秒 (全処理)
- **配置提案なし**: 3〜5秒 (応答生成まで)

### ローディング表示
```
┌─────────────────────────────────┐
│  🤖 AI分析中...                 │
│  Ollamaで配置最適化を計算しています │
│  ⏱️ ローカルLLMのため30秒〜1分かかります │
└─────────────────────────────────┘
```
- 実際: 5〜10秒で完了
- 表示: 余裕を持って「30秒〜1分」

---

## 🎨 UI要素の説明

### サイドバー
- **🚨 アラート**: リアルタイムアラート表示
- **⚡ クイックアクション**: データ更新、履歴確認
- **ℹ️ システム情報**: (今後実装)

### メイン画面
- **💬 配置調整アシスタント**: AIチャット
- **チャット履歴**: 過去の会話を表示
- **提案カード**: 配置変更の詳細と承認ボタン

### 提案カードの構成
1. **🔄 配置変更内容**: from拠点 → to拠点 (工程名: 人数)
2. **📈 予測される効果**: 生産性、遅延、品質
3. **💡 理由**: 提案理由
4. **ボタン**: ✅承認、❌却下、💬詳細相談

---

## 📱 操作手順

### 基本的な使い方

#### 1. システム起動
```bash
cd /Users/umemiya/Desktop/erax/aimee-fe
./docker-start-all.sh
```

起動完了まで: 約1〜2分 (初回は5〜10分)

#### 2. ブラウザアクセス
```
http://localhost:8501
```

#### 3. アラート確認
- サイドバーの「🚨 アラート」を確認
- アラートがあれば赤色・黄色で表示

#### 4. チャット入力
```
札幌のエントリ1が不足しています
```

#### 5. AI応答を待つ
- 紫色のローディング画面表示
- 5〜10秒待つ

#### 6. 提案を確認
- AI応答テキストを読む
- 提案カードで配置変更を確認

#### 7. 承認または却下
- ✅ **承認**: DB保存 → 別アプリが読み取り
- ❌ **却下**: 理由を記録
- 💬 **詳細相談**: さらに質問

---

## 🔧 開発者向け情報

### API直接テスト

#### アラートチェック
```bash
curl http://localhost:8002/api/v1/alerts/check
```

#### チャット
```bash
curl -X POST http://localhost:8002/api/v1/chat/message \
  -H "Content-Type: application/json" \
  -d '{"message":"札幌のエントリ1が不足しています","context":{}}'
```

#### 承認実行
```bash
curl -X POST http://localhost:8002/api/v1/approvals/SGT20251008-001/action \
  -H "Content-Type: application/json" \
  -d '{"action":"approve","user":"管理者","reason":"承認します"}'
```

### DBデータ確認
```bash
cd /Users/umemiya/Desktop/erax/aimee-db

# 配置状況確認
python3 -c "
from config import db_manager
result = db_manager.execute_query('''
    SELECT process_name, sapporo, tokyo, login_now
    FROM login_records_by_location
    WHERE business_name LIKE '%SS%'
    ORDER BY record_time DESC
    LIMIT 10
''')
for row in result:
    print(f\"{row['process_name']}: 札幌{row['sapporo']}名 東京{row['tokyo']}名 合計{row['login_now']}名\")
"

# 承認履歴確認
python3 -c "
from config import db_manager
result = db_manager.execute_query('''
    SELECT suggestion_id, action_type, action_user, created_at
    FROM approval_history
    ORDER BY created_at DESC
    LIMIT 5
''')
for row in result:
    print(f\"{row['suggestion_id']}: {row['action_type']} by {row['action_user']} at {row['created_at']}\")
"
```

### ログ確認
```bash
cd /Users/umemiya/Desktop/erax/aimee-be

# リアルタイムログ
docker-compose logs -f api

# 意図解析ログ
docker-compose logs api | grep "intent_type"

# 配置提案ログ
docker-compose logs api | grep "提案生成\|配置転換"

# エラーログ
docker-compose logs api | grep "ERROR"
```

---

## 💡 Tips

### 効果的な質問の仕方

#### ✅ Good
```
札幌のエントリ1が2名不足しています
品川の補正工程が30分遅延しています
東京のSV補正に人員を追加したいです
```

**理由**: 拠点名・工程名・問題内容が明確

#### ❌ Bad
```
どうにかして
よろしく
エラー出てます
```

**理由**: 具体性がない

### 複数の問題を相談する場合
```
1つ目の質問:
「札幌のエントリ1が不足しています」

AI応答を確認

2つ目の質問:
「品川の補正工程も確認してください」
```

**注意**: 一度に複数の質問をすると混乱する可能性があります

### データ更新のタイミング
- **リアルタイム性**: 現在は手動更新のみ
- **更新ボタン**: サイドバー「🔄 データ更新」
- **自動更新**: 今後実装予定 (2分間隔)

---

## 📊 配置提案の読み方

### 提案カード例
```
🔄 配置変更内容:
  佐世保 → 札幌 (エントリ1: 1名)
  東京   → 札幌 (エントリ2: 1名)

📈 予測される効果:
  生産性: +20%
  遅延: -30分
  品質: 維持

💡 理由:
  実データに基づく2名の配置調整
```

### 数値の意味
- **生産性**: 配置人数 × 10% (3名なら+30%)
- **遅延**: 配置人数 × 15分 (3名なら-45分)
- **品質**: 基本的に「維持」(5名以上の大規模配置で「+2%」)

### 信頼度スコア
- **0.85以上**: 高信頼度 (配置転換あり)
- **0.5〜0.7**: 中信頼度
- **0.5未満**: 低信頼度 (配置転換なし)

---

## ❓ よくある質問

### Q1: チャットが遅い
**A**: ローカルLLM (Ollama) を使用しているため、5〜10秒かかります。
- ローディング表示で進行状況を確認できます
- クラウドLLM (OpenAI) に切り替えると高速化可能 (今後実装)

### Q2: アラートが出たり出なかったりする
**A**: 修正済みです。現在は固定で2件のアラートを表示します。
- 🔴 SS案件大量受領アラート
- 🟡 長時間配置の検出

### Q3: 配置提案が出ない
**A**: 以下の条件を満たす必要があります:
1. 拠点名・工程名を具体的に指定
2. DBに余剰人員データがある (3名以上配置の拠点)
3. 同じ工程で不足がある

**確認方法**:
```bash
# DB内の配置データ確認
cd /Users/umemiya/Desktop/erax/aimee-db
python3 -c "from config import db_manager; result = db_manager.execute_query('SELECT * FROM login_records_by_location LIMIT 10'); print(result)"
```

### Q4: 承認したデータはどこに保存される?
**A**: `approval_history` テーブルに保存されます。

**確認方法**:
```bash
cd /Users/umemiya/Desktop/erax/aimee-db
python3 -c "from config import db_manager; result = db_manager.execute_query('SELECT * FROM approval_history ORDER BY created_at DESC LIMIT 5'); print(result)"
```

### Q5: エラーメッセージが出る
**A**: バックエンドが起動しているか確認してください。

```bash
# ヘルスチェック
curl http://localhost:8002/api/v1/health

# 起動していない場合
cd /Users/umemiya/Desktop/erax/aimee-fe
./docker-start-all.sh
```

### Q6: Ollamaのモデルがダウンロードされない
**A**: コンテナ内で手動ダウンロードが必要な場合があります。

```bash
# Ollama Lightでモデル確認
docker exec aimee-be-ollama-light-1 ollama list

# モデルダウンロード (必要な場合)
docker exec aimee-be-ollama-light-1 ollama pull qwen2:0.5b
docker exec aimee-be-ollama-main-1 ollama pull gemma3:4b
```

---

## 🎓 用語集

- **拠点**: 札幌、東京、大阪、沖縄、佐世保など
- **工程**: エントリ1、エントリ2、補正、SV補正、目検など
- **業務**: 新SS(W)、新SS(片道)、非SS など
- **余剰人員**: 3名以上配置されている拠点 (2名を残して余剰)
- **不足人員**: 1名以下の拠点 (2名を目標)
- **配置転換**: ある拠点から別の拠点へ人員を移動
- **RAG**: Retrieval-Augmented Generation (検索拡張生成)
- **Ollama**: ローカルLLM推論エンジン

---

## 📞 サポート

### エラー報告
- ログを添えて報告してください:
```bash
cd /Users/umemiya/Desktop/erax/aimee-be
docker-compose logs api --tail=100 > error_log.txt
```

### 機能要望
- CLAUDE.md の「未解決の質問・要確認事項」セクションを参照

---

**作成日**: 2025-10-08
**対象バージョン**: v1.0.0 (実データ統合完了版)
