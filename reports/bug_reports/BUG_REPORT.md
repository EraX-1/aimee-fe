# バグ報告書

**作成日**: 2025-10-16
**報告者**: システム調査
**対象システム**: AIMEE (AI配置最適化システム)

---

## 🐛 発見されたバグ一覧

### 1. 配置提案で複数人提案しても1人分しか表示されない

**発生状況**:
- AIが「原田次郎さん」「林淳さん」の2名を提案
- フロントエンドでは「2名」という人数のみ表示され、個別のオペレータ名が表示されない

**原因**:
- バックエンド(`integrated_llm_service.py:342`)で`operators`フィールドにオペレータ名リストを追加済み
- しかし、フロントエンド(`app.py:377-399`)で`change['count']`のみ表示し、`change['operators']`を表示していない

**改善策**:
```python
# app.py の show_suggestion_card() 関数を修正
# 現在: {change['count']}名 と表示
# 修正後: オペレータ名を個別に表示
# 例: "原田次郎さん、林淳さん (2名)" のように表示
```

**ファイル**: `frontend/app.py:377-399`
**優先度**: 高
**工数**: 30分

---

### 2. 承認/否認ボタンを押すとエラーが発生する

**発生状況**:
- 承認または否認ボタンをクリックするとエラーが発生
- DBにデータが保存されない

**原因**:
- `approvals.py:251-267`でDB保存処理がコメントアウトされている
- `# TODO: DB保存は今後実装` として実装されていない
- また、Pydantic v2では`.dict()`が`.model_dump()`に変更されているため、`approval.impact.dict()`でAttributeErrorの可能性

**改善策**:
```python
# 1. approvals.py:251-267 のコメントアウトを解除
# 2. approval.changes と approval.impact の変換を修正
# - Pydantic v2の場合: .model_dump() を使用
# - または dict() を使用して dict型に変換
# 3. DB接続エラー時のエラーハンドリングを追加
```

**ファイル**: `aimee-be/app/api/v1/endpoints/approvals.py:251-267`
**優先度**: 最優先
**工数**: 1時間

---

### 3. AIの配置提案ロジックが不適切

**発生状況**:
- 「品川から原田次郎さんを札幌へ配置転換」(同一工程エントリ1)
- 「札幌から橋本颯真さんを品川へ配置転換」(同一工程エントリ1)
- 同一工程での拠点間移動は意味がない

**原因**:
- `integrated_llm_service.py:269-351`の`_generate_delay_resolution_suggestion()`が同一工程の余剰/不足のみをマッチングしている
- **配置転換元の工程の健全性チェックがない**
- 例: 品川のエントリ1が余剰 → 札幌へ移動 → 品川も不足になる可能性

**改善策**:
```python
# 1. 配置転換元の工程が移動後も健全か確認
#    - 余剰が1名の場合は移動させない
#    - 移動後に不足にならないか計算
#
# 2. 別工程からの配置転換も検討
#    - 例: 品川のエントリ2が余剰 → 札幌のエントリ1へ移動
#    - スキル互換性を考慮
#
# 3. 配置転換の優先順位を設定
#    - 余剰度が高い拠点を優先
#    - 移動距離が近い拠点を優先
```

**ファイル**: `aimee-be/app/services/integrated_llm_service.py:234-371`
**優先度**: 最優先
**工数**: 3時間

---

### 4. 配置提案の理由を聞いても再度提案が返ってくる

**発生状況**:
- ユーザー: 「納期に間に合わない工程はありますか?」
- AI: 「品川から原田次郎さんを札幌へ配置転換することを提案します」
- ユーザー: 「配置転換する理由を教えてください」
- AI: 「品川から原田次郎さんを札幌へ配置転換することを提案します」(同じ回答)

**原因**:
- フロントエンド(`app.py:264-278`)で`st.session_state.messages`に会話履歴を保持
- しかし、`api_client.chat_with_ai()`でバックエンドに送信する際、**過去の会話履歴を渡していない**
- バックエンドの`IntegratedLLMService.process_message()`も**会話履歴を受け取る仕組みがない**
- 結果、毎回新しいセッションとして処理され、前回の提案内容を覚えていない

**改善策**:
```python
# 1. フロントエンド (api_client.py) の修正
#    - chat_with_ai() に history パラメータを追加
#    - st.session_state.messages を渡す
#
# 2. バックエンド (chat.py) の修正
#    - ChatMessageRequest に history フィールドを追加
#
# 3. IntegratedLLMService の修正
#    - process_message() に history パラメータを追加
#    - 会話履歴を考慮した応答生成
#    - 「理由を教えてください」→ 前回の suggestion.reason を返す
```

**ファイル**:
- `frontend/src/utils/api_client.py:80-104`
- `aimee-be/app/api/v1/endpoints/chat.py:69-161`
- `aimee-be/app/services/integrated_llm_service.py:26-213`

**優先度**: 高
**工数**: 2時間

---

## 📊 優先度

| No | バグ | 影響度 | 優先度 |
|----|------|--------|--------|
| 1 | 複数人提案が1人しか表示されない | 中 | 高 |
| 2 | 承認/否認ボタンエラー | 高 | **最優先** |
| 3 | 配置提案ロジックが不適切 | 高 | **最優先** |
| 4 | 理由を聞いても再度提案が返る | 中 | 高 |

---

## 🔧 修正作業の見積もり

| No | バグ | 修正工数 | 難易度 |
|----|------|----------|--------|
| 1 | 複数人表示 | 30分 | 低 |
| 2 | 承認/否認エラー | 1時間 | 中 |
| 3 | 配置提案ロジック | 3時間 | 高 |
| 4 | 会話履歴対応 | 2時間 | 中 |

**合計**: 約6.5時間

---

## ✅ 次のアクション

1. **最優先**: バグ2(承認/否認エラー)の修正
   - DB保存処理のコメントアウト解除
   - Pydantic v2対応

2. **最優先**: バグ3(配置提案ロジック)の修正
   - 配置転換元の健全性チェック追加
   - 別工程からの配置転換ロジック実装

3. **高優先**: バグ1(複数人表示)の修正
   - フロントエンドのUI改善

4. **高優先**: バグ4(会話履歴)の修正
   - API拡張(history対応)
   - バックエンドロジック改善

---

**報告書終了**
